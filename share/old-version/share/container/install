#!/usr/bin/env bash
set -e

SCRIPT_DIR="$(cd "$(dirname "$0")" 2>/dev/null && pwd)"
INSTALL_D_DIR="${SCRIPT_DIR}/install.d"
DEFAULT_INSTALLER="${INSTALL_D_DIR}/default"
CONFIG_FOLDER="${HOME}/.config/tmoe-linux"
LINUX_CONTAINER_DISTRO_FILE="${CONFIG_FOLDER}/linux_container_distro.txt"

normalize_distro_name() {
    local distro="${1,,}"
    distro="${distro%%_*}"
    distro="${distro%%-*}"
    printf '%s\n' "${distro}"
}

pick_installer() {
    local raw_distro distro
    if [ -s "${LINUX_CONTAINER_DISTRO_FILE}" ]; then
        raw_distro="$(head -n 1 "${LINUX_CONTAINER_DISTRO_FILE}")"
    else
        raw_distro='debian'
    fi

    distro="$(normalize_distro_name "${raw_distro}")"
    case "${distro}" in
    archlinux) distro='arch' ;;
    opensuse*|suse) distro='opensuse' ;;
    manjaro) distro='manjaro' ;;
    centos|rhel|rocky|alma|almalinux) distro='rpm' ;;
    *) ;;
    esac

    if [ -x "${INSTALL_D_DIR}/${distro}" ]; then
        printf '%s\n' "${INSTALL_D_DIR}/${distro}"
    else
        printf '%s\n' "${DEFAULT_INSTALLER}"
    fi
}

INSTALLER_BIN="$(pick_installer)"
exec "${INSTALLER_BIN}" "$@"
